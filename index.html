<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UNI-check â€” WASSCE â†’ University Program Finder (Full)</title>
  <style>
    :root{
      --bg:#071025;--card:#071826;--muted:#97a6b8;--accent:#60a5fa;--accent-2:#7dd3fc;
      --glass:rgba(255,255,255,0.04);--success:#10b981;--danger:#ef4444
    }
    *{box-sizing:border-box}html,body{height:100%}body{
      font-family:Inter,Segoe UI,Roboto,system-ui,Arial;background:linear-gradient(180deg,#031227 0%,#071025 100%);
      color:#e6eef6;margin:0;padding:28px;-webkit-font-smoothing:antialiased
    }
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:14px;margin-bottom:20px}
    h1{margin:0;font-size:1.35rem;letter-spacing:0.2px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(3,8,20,.6);border:1px solid rgba(255,255,255,0.02)}
    label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:8px}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}.subjects{margin-top:12px}.subject-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}.subject-row input[type=text]{flex:1;padding:8px}.subject-row select{width:130px;padding:8px;border-radius:8px}
    .actions{display:flex;gap:8px;margin-top:12px}button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#072033}button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .results{margin-top:14px}.programme{padding:12px;border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));box-shadow:inset 0 -1px 0 rgba(255,255,255,0.01)}
    .hint{font-size:.88rem;color:var(--muted);margin-top:8px}textarea{height:220px;padding:12px;border-radius:10px;background:#021424;color:#cfe8ff;border:1px dashed rgba(255,255,255,0.03)}.flex{display:flex;gap:8px;align-items:center}footer{margin-top:18px;color:var(--muted);font-size:.85rem}.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);font-size:.8rem;color:var(--muted)}.small{font-size:.82rem;color:var(--muted)}@media (max-width:900px){.grid{grid-template-columns:1fr}}.center{display:flex;align-items:center;justify-content:center}.reason{color:var(--muted);font-size:.82rem;margin-top:6px}.bad{color:#ffb4b4}.good{color:#b4ffd6}.qualified-label{font-weight:800;color:var(--success);margin-left:8px}
    .toggle { display:inline-flex; gap:8px; align-items:center; }
    .tag { font-size:0.8rem; padding:4px 8px; border-radius:8px; background:rgba(255,255,255,0.02); }
    .footer-note{font-size:.78rem;color:#9fb0c9;margin-top:12px}
    .program-meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  </style>

<style>
#admin-mappings,
#admin-mappings * {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
}
</style>


<style>
#saveMap,
#loadDefaults {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    pointer-events: none !important;
}
</style>

</head>
<body>
  <div class="container">
    <header>
      <div class="card" style="display:inline-block;padding:10px;border-radius:10px">ðŸŽ“</div>
      <div>
        <h1>UNI-check â€” Per-university Engine (UG, KNUST, UCC, UDS, UMaT, UHAS, UPSA, UEW)</h1>
        <div class="hint">Enter WASSCE grades and get programmes that match university requirements. Payment (GHâ‚µ18) required to reveal results (demo mode supported).</div>
      </div>
    </header>

    <section class="card" id="mainCard">
      <div class="grid">
        <div>
          <label for="university">Choose university</label>
          <select id="university">
            <option value="UG">University of Ghana (UG)</option>
            <option value="KNUST">KNUST</option>
            <option value="UCC">University of Cape Coast (UCC)</option>
            <option value="UDS">University for Development Studies (UDS)</option>
            <option value="UMaT">UMaT</option>
            <option value="UPSA">UPSA</option>
            <option value="UEW">UEW</option>
            <option value="UHAS">UHAS</option>
          </select>
        </div>
        <div>
          <label for="stream">SHS Stream</label>
          <select id="stream">
            <option value="GeneralScience">General Science</option>
            <option value="GeneralArts">General Arts</option>
            <option value="Business">Business</option>
            <option value="VisualArts">Visual Arts</option>
            <option value="HomeEconomics">Home Economics</option>
            <option value="Technical">Technical/Vocational</option>
            <option value="Agricultural">Agricultural</option>
          </select>
        </div>
      </div>

      <div class="subjects" style="margin-top:14px">
        <label>Subjects & Grades (WASSCE: A1,B2,B3,C4,C5,C6,D7,E8,F9)</label>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <div class="pill small">Tip: choose SHS stream to auto-fill typical subjects</div>
          <div class="pill small">Per-university rules active: <span id="ruleEngineTag" class="tag">Per-Uni</span></div>
        </div>
        <div class="hint small">Enter up to 9 subjects (best 6 used for aggregate). Required subjects must be credit (A1â€“C6).</div>
        <div id="subjectList"></div>

        <div class="actions" style="margin-top:10px">
          <button id="addSub" class="ghost">+ Add subject</button>
          <button id="resetSubs" class="ghost">Reset subjects</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="payThenGenerate" class="primary">Pay GHâ‚µ18 & Get Programmes</button>
          <button id="clearRes" class="ghost">Clear results</button>
          <button id="demoRun" class="ghost" style="display:none">Demo (disabled)</button>
        </div>

        <div class="results" id="results"></div>
        <div class="hint small">Tip: This uses a configurable rule-set â€” edit Admin Mappings below to keep rules & cutoffs up-to-date with official university pages.</div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h3 style="margin-top:0"><span style="display:none">Admin Mappings (JSON)</span></h3>
      <div class="hint small">Each programme: <code>name</code>, <code>requiredSubjects</code>, <code>maxAggregate</code> (null = unknown). Update cut-offs when the universities publish new ones.</div>
      <textarea id="mappings" style="display:none"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="saveMap" class="primary">Save mappings</button>
        <button id="loadDefaults" class="ghost">Load defaults (overwrite)</button>
      </div>
      <div class="footer-note">Warning: do not trust unknown (null) cutoffs â€” verify with official university pages.</div>
    </section>

    <footer class="hint">Data built from universities' admissions pages & PDFs â€” verify official pages for final decisions.</footer>
  </div>

  <!-- optional paystack library (kept same) -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <script>
/* ============================
   FULL PER-UNIVERSITY RULE ENGINE (C)
   JSON PROGRAMS included below (expanded).
   ============================ */

/* Grade mapping */
const GRADE_TO_SCORE = { 'A1':1,'B2':2,'B3':3,'C4':4,'C5':5,'C6':6,'D7':7,'E8':8,'F9':9 };

/* ============================
   BIG PROGRAM DATABASE
   - expanded programmes for UG, KNUST, UCC, UDS, UMaT, UHAS, UPSA, UEW
   - physics added to every engineering programme's requiredSubjects
   - maxAggregate: number when known; null when unknown
   ============================ */
const DEFAULT_UNIVERSITY_PROGRAMMES = {
  "UG":[
    {"name":"Bachelor of Medicine & Bachelor of Surgery (MB ChB)","canonicalType":"medicine","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":7},
    {"name":"Bachelor of Dental Surgery (BDS)","canonicalType":"dentistry","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":8},
    {"name":"Doctor of Pharmacy (PharmD)","canonicalType":"pharmacy","requiredSubjects":["Biology","Chemistry"],"maxAggregate":8},
    {"name":"BSc Nursing","canonicalType":"nursing","requiredSubjects":["Biology","Chemistry"],"maxAggregate":8},
    {"name":"BSc Midwifery","canonicalType":"midwifery","requiredSubjects":["Biology","Chemistry"],"maxAggregate":9},
    {"name":"BSc Medical Laboratory Science","canonicalType":"medical laboratory science","requiredSubjects":["Biology","Chemistry"],"maxAggregate":12},
    {"name":"BSc Physiotherapy","canonicalType":"physiotherapy","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":14},
    {"name":"BSc Occupational Therapy","canonicalType":"occupational therapy","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":15},
    {"name":"BSc Diagnostic Radiography","canonicalType":"radiography","requiredSubjects":["Physics","Biology","Chemistry"],"maxAggregate":13},
    {"name":"BSc Dietetics / Nutrition","canonicalType":"dietetics","requiredSubjects":["Biology","Chemistry"],"maxAggregate":14},
    {"name":"BSc Biomedical Science","canonicalType":"biomedical science","requiredSubjects":["Biology","Chemistry"],"maxAggregate":13},
    {"name":"BSc Biological Sciences","canonicalType":"biological sciences","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":14},
    {"name":"BSc Chemistry","canonicalType":"chemistry","requiredSubjects":["Chemistry","Physics"],"maxAggregate":24},
    {"name":"BSc Physics","canonicalType":"physics","requiredSubjects":["Physics","Mathematics"],"maxAggregate":24},
    {"name":"BSc Mathematics","canonicalType":"mathematics","requiredSubjects":["Mathematics","Elective Mathematics"],"maxAggregate":12},
    {"name":"BSc Actuarial Science","canonicalType":"actuarial science","requiredSubjects":["Elective Mathematics"],"maxAggregate":10},
    {"name":"BSc Statistics","canonicalType":"statistics","requiredSubjects":["Mathematics"],"maxAggregate":12},
    {"name":"BSc Computer Science","canonicalType":"computer science","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":7},
    {"name":"BSc Information Technology","canonicalType":"it","requiredSubjects":["Core Mathematics","Elective Mathematics"],"maxAggregate":7},
    {"name":"BSc Computer Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":6},
    {"name":"BSc Computer Systems Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":6},
    {"name":"BSc Biomedical Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":7},
    {"name":"BSc Electrical/Electronic Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":8},
    {"name":"BSc Mechanical Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":10},
    {"name":"BSc Civil Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":10},
    {"name":"BSc Petroleum Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics","Chemistry"],"maxAggregate":6},
    {"name":"BSc Agricultural Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":17},
    {"name":"BSc Food Process Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":12},
    {"name":"BSc Materials Science & Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics","Chemistry"],"maxAggregate":12},
    {"name":"BSc Geography & Resource Development","canonicalType":"geography","requiredSubjects":["Geography","Core Mathematics"],"maxAggregate":18},
    {"name":"BSc Agriculture","canonicalType":"agriculture","requiredSubjects":["Biology","Chemistry"],"maxAggregate":20},
    {"name":"BSc Agribusiness/Agricultural Economics","canonicalType":"agrobusiness","requiredSubjects":["Economics","Mathematics"],"maxAggregate":null},
    {"name":"BSc Forestry/Natural Resource Management","canonicalType":"environment","requiredSubjects":["Biology","Chemistry"],"maxAggregate":null},
    {"name":"BSc Environmental Science","canonicalType":"environment","requiredSubjects":["Biology","Chemistry"],"maxAggregate":null},
    {"name":"BSc Finance/Accounting (Business)","canonicalType":"business","requiredSubjects":["Mathematics","English Language"],"maxAggregate":7},
    {"name":"BSc Banking & Finance","canonicalType":"finance","requiredSubjects":["Elective Mathematics"],"maxAggregate":8},
    {"name":"BSc Accounting","canonicalType":"accounting","requiredSubjects":["Elective Mathematics"],"maxAggregate":7},
    {"name":"BSc Economics","canonicalType":"economics","requiredSubjects":["Mathematics"],"maxAggregate":14},
    {"name":"Bachelor of Laws (LLB)","canonicalType":"law","requiredSubjects":["English Language"],"maxAggregate":6},
    {"name":"BA English / Communication Studies","canonicalType":"arts","requiredSubjects":["English Language"],"maxAggregate":null},
    {"name":"BA History/Archaeology","canonicalType":"arts","requiredSubjects":["Social Studies","English Language"],"maxAggregate":null},
    {"name":"BA Political Science","canonicalType":"social science","requiredSubjects":["English Language","Social Studies"],"maxAggregate":null},
    {"name":"BEd (Various Subjects)","canonicalType":"education","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":24}
  ],
  "KNUST":[
    {"name":"BSc Agriculture","canonicalType":"agriculture","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":20},
    {"name":"BSc Agricultural Biotechnology","canonicalType":"agriculture","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":17},
    {"name":"BSc Agribusiness Management","canonicalType":"business","requiredSubjects":["Mathematics","Elective Mathematics"],"maxAggregate":15},
    {"name":"BSc Aquaculture & Water Resources Management","canonicalType":"environment","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":20},
    {"name":"BSc Forest Resources Technology","canonicalType":"environment","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":24},
    {"name":"BSc Natural Resources Management","canonicalType":"environment","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":18},
    {"name":"BSc Packaging Technology","canonicalType":"technology","requiredSubjects":["Mathematics","Chemistry","Physics"],"maxAggregate":15},
    {"name":"BSc Mechanical Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":null},
    {"name":"BSc Civil Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":null},
    {"name":"BSc Chemical Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics","Chemistry"],"maxAggregate":null},
    {"name":"BSc Electrical/Electronic Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":null},
    {"name":"BSc Computer Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":null},
    {"name":"BSc Petroleum Engineering","canonicalType":"engineering","requiredSubjects":["Elective Mathematics","Physics","Chemistry"],"maxAggregate":null},
    {"name":"BSc Architecture","canonicalType":"architecture","requiredSubjects":[" Elective Mathematics"],"maxAggregate":9},
    {"name":"BSc Building Technology/Construction Management","canonicalType":"construction","requiredSubjects":["Mathematics","Physics"],"maxAggregate":12},
    {"name":"BSc Quantity Surveying","canonicalType":"planning","requiredSubjects":["Elective Mathematics"],"maxAggregate":11},
    {"name":"BSc Computer Science","canonicalType":"computer science","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":11},
    {"name":"BSc Mathematics","canonicalType":"mathematics","requiredSubjects":["Elective Mathematics"],"maxAggregate":17},
    {"name":"BSc Actuarial Science","canonicalType":"actuarial science","requiredSubjects":["Elective Mathematics"],"maxAggregate":11},
    {"name":"BSc Biochemistry","canonicalType":"biochemistry","requiredSubjects":["Biology","Chemistry"],"maxAggregate":12},
    {"name":"BSc Chemistry","canonicalType":"chemistry","requiredSubjects":["Chemistry","Physics"],"maxAggregate":null},
    {"name":"BSc Physics","canonicalType":"physics","requiredSubjects":["Physics","Mathematics"],"maxAggregate":null},
    {"name":"BSc Biology (Biological Sciences)","canonicalType":"biology","requiredSubjects":["Biology","Chemistry"],"maxAggregate":null},
    {"name":"BSc Business Administration","canonicalType":"business","requiredSubjects":["Mathematics","English Language"],"maxAggregate":null},
    {"name":"BSc Accounting","canonicalType":"accounting","requiredSubjects":["Mathematics","English Language"],"maxAggregate":null}
  ],
  "UCC":[
    {"name":"BCom (Finance)","canonicalType":"finance","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":15},
    {"name":"BCom (Accounting)","canonicalType":"accounting","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":12},
    {"name":"BCom (Marketing)","canonicalType":"business","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":20},
    {"name":"BSc Computer Science","canonicalType":"computer science","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":21},
    {"name":"BSc Environmental Science","canonicalType":"environment","requiredSubjects":["Biology","Chemistry"],"maxAggregate":29},
    {"name":"BSc Actuarial Science","canonicalType":"actuarial science","requiredSubjects":["Elective Mathematics"],"maxAggregate":14},
    {"name":"BSc Nursing","canonicalType":"nursing","requiredSubjects":["Biology","Chemistry"],"maxAggregate":11},
    {"name":"BSc Biochemistry","canonicalType":"biochemistry","requiredSubjects":["Biology","Chemistry"],"maxAggregate":15},
    {"name":"BA Communication Studies","canonicalType":"communication","requiredSubjects":["English Language"],"maxAggregate":19},
    {"name":"BA Geography & Regional Planning","canonicalType":"planning","requiredSubjects":["Geography","Core Mathematics"],"maxAggregate":18},
    {"name":"BA Social Sciences (Economics)","canonicalType":"economics","requiredSubjects":["Mathematics"],"maxAggregate":25},
    {"name":"BSc Tourism Management","canonicalType":"tourism","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":32},
    {"name":"BSc Hospitality Management","canonicalType":"hospitality","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":20},
    {"name":"BA Anthropology","canonicalType":"social science","requiredSubjects":["English Language"],"maxAggregate":28},
    {"name":"BSc Fisheries & Aquatic Science","canonicalType":"environment","requiredSubjects":["Biology","Chemistry"],"maxAggregate":30},
    {"name":"BA Music","canonicalType":"music","requiredSubjects":["English Language"],"maxAggregate":28},
    {"name":"BA Theatre Arts","canonicalType":"arts","requiredSubjects":["English Language"],"maxAggregate":28},
    {"name":"BA Linguistics","canonicalType":"linguistics","requiredSubjects":["English Language"],"maxAggregate":26},
    {"name":"BA Film Studies","canonicalType":"arts","requiredSubjects":["English Language"],"maxAggregate":33},
    {"name":"BSc Agriculture","canonicalType":"agriculture","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":null}
  ],
  "UDS":[
    {"name":"BSc Nursing","canonicalType":"nursing","requiredSubjects":["Biology","Chemistry","English Language"],"maxAggregate":10},
    {"name":"BSc Midwifery","canonicalType":"midwifery","requiredSubjects":["Biology","Chemistry","English Language"],"maxAggregate":10},
    {"name":"BSc Medical Laboratory Science","canonicalType":"medical laboratory science","requiredSubjects":["Biology","Chemistry"],"maxAggregate":12},
    {"name":"MBChB","canonicalType":"medicine","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":9},
    {"name":"Doctor of Pharmacy","canonicalType":"pharmacy","requiredSubjects":["Biology","Chemistry"],"maxAggregate":12},
    {"name":"BSc Public Health","canonicalType":"public health","requiredSubjects":["Biology","Chemistry"],"maxAggregate":null},
    {"name":"BSc Community Nutrition","canonicalType":"nutrition","requiredSubjects":["Biology","Chemistry","Mathematics"],"maxAggregate":14},
    {"name":"BSc Agriculture","canonicalType":"agriculture","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":null},
    {"name":"BSc Environmental Science","canonicalType":"environment","requiredSubjects":["Biology","Chemistry"],"maxAggregate":null},
    {"name":"BSc Geography","canonicalType":"geography","requiredSubjects":["Geography","Mathematics"],"maxAggregate":null}
  ],
  "UMaT":[
    {"name":"BSc Mining Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Chemistry","Elective Mathematics"],"maxAggregate":8},
    {"name":"BSc Minerals Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Chemistry","Elective Mathematics"],"maxAggregate":null},
    {"name":"BSc Geological Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Chemistry","Mathematics"],"maxAggregate":9},
    {"name":"BSc Geomatic (Geodetic) Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Mathematics"],"maxAggregate":10},
    {"name":"BSc Mechanical Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Elective Mathematics"],"maxAggregate":9},
    {"name":"BSc Electrical & Electronic Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Elective Mathematics"],"maxAggregate":7},
    {"name":"BSc Computer Science & Engineering","canonicalType":"computer science","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":8},
    {"name":"BSc Petroleum Engineering","canonicalType":"engineering","requiredSubjects":["Physics","Chemistry","Elective Mathematics"],"maxAggregate":6},
    {"name":"BSc Mathematics","canonicalType":"mathematics","requiredSubjects":["Mathematics"],"maxAggregate":15},
    {"name":"BSc Petrochemical Engineering","canonicalType":"engineering","requiredSubjects":["Chemistry","Physics","Mathematics"],"maxAggregate":13}
  ],
  "UHAS":[
    {"name":"MBChB","canonicalType":"medicine","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":8},
    {"name":"BDS","canonicalType":"dentistry","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":8},
    {"name":"Bachelor of Physician Assistantship","canonicalType":"pa","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":9},
    {"name":"PharmD","canonicalType":"pharmacy","requiredSubjects":["Biology","Chemistry"],"maxAggregate":8},
    {"name":"BSc Nursing","canonicalType":"nursing","requiredSubjects":["Biology","Chemistry"],"maxAggregate":10},
    {"name":"BSc Midwifery","canonicalType":"midwifery","requiredSubjects":["Biology","Chemistry"],"maxAggregate":10},
    {"name":"BSc Medical Laboratory Science","canonicalType":"medical laboratory science","requiredSubjects":["Biology","Chemistry"],"maxAggregate":12},
    {"name":"BSc Dietetics","canonicalType":"dietetics","requiredSubjects":["Biology","Chemistry"],"maxAggregate":14},
    {"name":"BSc Physiotherapy","canonicalType":"physiotherapy","requiredSubjects":["Biology","Chemistry","Physics"],"maxAggregate":16},
    {"name":"BSc Radiography/Diagnostic Imaging","canonicalType":"radiography","requiredSubjects":["Physics","Biology","Chemistry"],"maxAggregate":14}
  ],
  "UPSA":[
    {"name":"BSc Accounting","canonicalType":"accounting","requiredSubjects":["Elective Mathematics"],"maxAggregate":8},
    {"name":"BSc Accounting & Finance","canonicalType":"accounting","requiredSubjects":["Elective Mathematics"],"maxAggregate":null},
    {"name":"BSc Banking & Finance","canonicalType":"finance","requiredSubjects":["Elective Mathematics"],"maxAggregate":8},
    {"name":"BSc Information Technology Management","canonicalType":"it","requiredSubjects":["Elective Mathematics"],"maxAggregate":10},
    {"name":"BSc Actuarial Science","canonicalType":"actuarial science","requiredSubjects":["Elective Mathematics"],"maxAggregate":null},
    {"name":"BSc Data Science & Analytics","canonicalType":"data science","requiredSubjects":["Elective Mathematics"],"maxAggregate":null},
    {"name":"BBA (Management)","canonicalType":"management","requiredSubjects":["English Language","Mathematics"],"maxAggregate":10},
    {"name":"LLB (Law)","canonicalType":"law","requiredSubjects":["English Language"],"maxAggregate":7},
    {"name":"BSc Logistics & Transport Management","canonicalType":"logistics","requiredSubjects":["Mathematics","English Language"],"maxAggregate":null},
    {"name":"BA Communication Studies","canonicalType":"communication","requiredSubjects":["English Language"],"maxAggregate":null}
  ],
  "UEW":[
    {"name":"BEd Basic Education","canonicalType":"education","requiredSubjects":["English Language","Core Mathematics","Social Studies"],"maxAggregate":36},
    {"name":"BEd Early Childhood Education","canonicalType":"education","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":36},
    {"name":"BEd Primary Education","canonicalType":"education","requiredSubjects":["English Language","Core Mathematics"],"maxAggregate":36},
    {"name":"BA Education (Accounting)","canonicalType":"education","requiredSubjects":["Mathematics","Accounting"],"maxAggregate":null},
    {"name":"BA Education (Social Studies)","canonicalType":"education","requiredSubjects":["Social Studies","English Language"],"maxAggregate":null},
    {"name":"BSc Computer Science Education","canonicalType":"education","requiredSubjects":["Elective Mathematics","Physics"],"maxAggregate":null},
    {"name":"BA English Education","canonicalType":"education","requiredSubjects":["English Language"],"maxAggregate":null},
    {"name":"BSc Mathematics Education","canonicalType":"education","requiredSubjects":["Mathematics","Elective Mathematics"],"maxAggregate":null},
    {"name":"BEd Vocational Education","canonicalType":"education","requiredSubjects":["Technical Drawing","Mathematics"],"maxAggregate":null},
    {"name":"BEd Home Economics","canonicalType":"education","requiredSubjects":["Food and Nutrition","Biology"],"maxAggregate":null}
  ]
}; /* end DEFAULT_UNIVERSITY_PROGRAMMES */

/* ============================
   Per-University Rule Definitions
   - Core subjects lists and how many core credits required
   - Whether program cutoffs are strictly enforced
   ============================ */
const UNIVERSITY_RULES = {
  "UG": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 3, requireBest6:true, require6Subjects:true, strictCutoff:true },
  "KNUST": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 3, requireBest6:true, require6Subjects:true, strictCutoff:true },
  "UCC": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 3, requireBest6:true, require6Subjects:true, strictCutoff:true, uccAggregateMax:36 },
  "UDS": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 2, requireBest6:true, require6Subjects:true, strictCutoff:false },
  "UMaT": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 3, requireBest6:true, require6Subjects:true, strictCutoff:true },
  "UHAS": { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount: 3, requireBest6:true, require6Subjects:true, strictCutoff:true },
  "UPSA": { cores: ["english language","mathematics"], coreRequiredCount: 2, requireBest6:true, require6Subjects:true, strictCutoff:false },
  "UEW": { cores: ["english language","mathematics","social studies"], coreRequiredCount: 2, requireBest6:true, require6Subjects:true, strictCutoff:false }
};
/* ============================
   PROGRAM-SPECIFIC RULES (STRICT, PDF-sourced where available)
   - KNUST_PROGRAM_RULES: explicit per-programme rules that accept multiple SHS background groups
   - OTHER_UNI_PROGRAM_RULES: rules for other universities (UMaT, UG, UCC, UPSA, UHAS, UDS, UEW)
   Note: rule keys are lowercased program canonicalType or simplified program name tokens.
   Each rule:
     core: [subjects] (must be credited)
     electiveGroups: [{name, pool:[subjects], minCredits, requiresIntegratedScienceCredit?}]
     minAggregate: number | null
     source: 'URL or PDF reference' (for maintainers)
   ============================ */
const PROGRAM_SPECIFIC_RULES = {
  "KNUST": {
    // Architecture (from KNUST Admission Requirements PDF)
    "architecture": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [
        { name: "Technical", pool: ["Technical Drawing","Engineering Science","Woodwork","Metalwork","Building Construction"], minCredits: 2 },
        { name: "Science", pool: ["Biology","Chemistry","Physics"], minCredits: 2 },
        { name: "Visual Arts", pool: ["General Knowledge in Art","Graphic Design","Picture Making","G.K.A","Graphic Design"], minCredits: 2 },
        { name: "General Arts", pool: ["Economics","Geography"], minCredits: 2 }
      ],
      requiresMathCredit: true,
      minAggregate: null,
      source: "KNUST Admission Requirements PDF"
    },

    // Agribusiness / Agribusiness Management
    "agribusiness": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [
        { name: "Science", pool: ["Chemistry","Physics","Mathematics","Biology"], minCredits: 3 },
        { name: "Business", pool: ["Economics","Accounting","Business Management","Cost Accounting","Elective Mathematics","Business Mathematics"], minCredits: 3, requiresIntegratedScienceCredit: true },
        { name: "General Arts", pool: ["Economics","Geography","Elective Mathematics"], minCredits: 3, requiresIntegratedScienceCredit: true },
        { name: "Agriculture", pool: ["General Agriculture","Biology","Crop Husbandry","Horticulture","Chemistry"], minCredits: 3 }
      ],
      requiresMathCredit: false,
      minAggregate: 15,
      source: "KNUST Admission Requirements PDF"
    },

    // Quantity Surveying / Building / Construction related (built environment)
    "quantity surveying": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [
        { name: "Science", pool: ["Mathematics","Elective Mathematics","Physics"], minCredits: 2 },
        { name: "Technical", pool: ["Technical Drawing","Building Construction","Design & Communication Technology"], minCredits: 2 }
      ],
      requiresMathCredit: true,
      minAggregate: null,
      source: "KNUST Admission Requirements PDF"
    },

    // Civil, Mechanical, Electrical, Computer, Petroleum ... engineering: Science/Technical focus
    "engineering": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [
        { name: "Science/Maths", pool: ["Physics","Elective Mathematics","Mathematics","Chemistry"], minCredits: 2 },
        { name: "Technical", pool: ["Applied Electricity","Electronics","Technical Drawing","Metal Work","Engineering Science"], minCredits: 2 }
      ],
      requiresMathCredit: true,
      minAggregate: null,
      source: "KNUST Faculty/Dept Admission Pages"
    },

    // Computer Science / ICT / Information Technology
    "computer science": {
      core: ["English Language","Mathematics"],
      electiveGroups: [
        { name: "Maths Group", pool: ["Elective Mathematics","Mathematics","Physics"], minCredits: 1 }
      ],
      requiresMathCredit: true,
      minAggregate: null,
      source: "KNUST Admission Requirements"
    },

    // Law (LLB)
    "law": {
      core: ["English Language","Mathematics"],
      electiveGroups: [
        { name: "Arts/Business/Science", pool: ["Economics","Government","History","Geography","Business Management","Accounting","Elective Mathematics"], minCredits: 3 }
      ],
      requiresMathCredit: false,
      minAggregate: 20,
      source: "KNUST Law Admission Page"
    },

    // Nursing, Pharmacy, Medicine etc. (health sciences) - strict science requirements
    "medicine": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [
        { name: "Health Sciences", pool: ["Biology","Chemistry","Physics"], minCredits: 3 }
      ],
      requiresMathCredit: false,
      minAggregate: 9,
      source: "KNUST College of Health Sciences"
    },
    "pharmacy": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Health Sciences", pool: ["Biology","Chemistry","Physics"], minCredits: 2 }],
      requiresMathCredit: false,
      minAggregate: 8,
      source: "KNUST College of Health Sciences"
    },
    "nursing": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Nursing Sci", pool: ["Biology","Chemistry","Health Science","Integrated Science"], minCredits: 2 }],
      requiresMathCredit: false,
      minAggregate: 11,
      source: "KNUST College of Health Sciences"
    },

    // Business & Accounting
    "business administration": {
      core: ["English Language","Mathematics"],
      electiveGroups: [
        { name: "Business", pool: ["Business Management","Economics","Accounting","Cost Accounting","Elective Mathematics"], minCredits: 2 },
        { name: "Arts", pool: ["Economics","Geography","Government","History"], minCredits: 2 },
        { name: "Science", pool: ["Mathematics","Elective Mathematics","Physics","Chemistry","Biology"], minCredits: 2 }
      ],
      requiresMathCredit: true,
      minAggregate: null,
      source: "KNUST Admission Requirements"
    },

    // Chemistry/Biology related
    "chemistry": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Chem/Bio", pool: ["Chemistry","Physics","Mathematics","Biology"], minCredits: 2 }],
      requiresMathCredit: false,
      minAggregate: 12,
      source: "KNUST Dept pages"
    }
    // Add more KNUST programmes with explicit PDF-backed rules as needed...
  },

  /* UMaT: focused engineering rules (examples) */
  "UMaT": {
    "engineering": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Eng Group", pool: ["Physics","Elective Mathematics","Applied Electricity","Electronics","Technical Drawing"], minCredits: 2 }],
      requiresMathCredit: true,
      minAggregate: null,
      source: "UMaT Faculty Admission Pages"
    }
  },

  /* UG (University of Ghana) â€” selected strict rules */
  "UG": {
    "medicine": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Med Sci", pool: ["Biology","Chemistry","Physics"], minCredits: 3 }],
      requiresMathCredit: false,
      minAggregate: 7,
      source: "UG Admissions"
    },
    "law": {
      core: ["English Language","Mathematics"],
      electiveGroups: [{ name: "Law Group", pool: ["Economics","Government","History","Geography","Business Management"], minCredits: 3 }],
      requiresMathCredit: false,
      minAggregate: 6,
      source: "UG Law Admissions"
    },
    "computer science": {
      core: ["English Language","Mathematics"],
      electiveGroups: [{ name: "CS Group", pool: ["Elective Mathematics","Mathematics","Physics"], minCredits: 1 }],
      requiresMathCredit: true,
      minAggregate: null,
      source: "UG Admissions / Dept pages"
    }
  },

  /* UCC, UPSA, UHAS, UDS, UEW: add common program rules (examples) */
  "UCC": {
    "nursing": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Nursing", pool: ["Biology","Chemistry"], minCredits: 2 }],
      requiresMathCredit: false,
      minAggregate: 11,
      source: "UCC Admissions"
    }
  },
  "UPSA": {
    "accounting": {
      core: ["English Language","Mathematics"],
      electiveGroups: [{ name: "Acct", pool: ["Elective Mathematics","Accounting"], minCredits: 1 }],
      requiresMathCredit: true,
      minAggregate: 8,
      source: "UPSA Admissions"
    }
  },
  "UHAS": {
    "medicine": {
      core: ["English Language","Mathematics","Integrated Science"],
      electiveGroups: [{ name: "Med Sci", pool: ["Biology","Chemistry","Physics"], minCredits: 3 }],
      requiresMathCredit: false,
      minAggregate: 8,
      source: "UHAS Admissions"
    }
  }
};
/* End PROGRAM_SPECIFIC_RULES */


/* SHS track hints used for friendly messaging (not strict) */
const SHS_TRACK_RULES = {
  "generalscience": ["engineering","computer science","nursing","midwifery","pharmacy","medicine","dentistry","agriculture","environmental science","mathematics","statistics","business","law","education"],
  "generalarts": ["law","business","education","social science","humanities","communication","journalism","marketing","economics","arts"],
  "business": ["business","accounting","banking and finance","marketing","management","economics","education"],
  "visualarts": ["architecture","design","arts","theatre arts"],
  "homeeconomics": ["home science","hospitality","food science","nutrition","education"],
  "technical": ["engineering","industrial arts","architecture","building technology","technical"],
  "agricultural": ["agriculture","animal science","forestry","environmental science","food science","agribusiness"]
};

/* ============================
   Subject normalization
   - canonical lowercase names
   ============================ */
function normalizeSubject(s){
  if (!s && s !== '') return '';
  let t = s.toString().trim().toLowerCase();
  t = t.replace(/\s+/g, ' ');
  // common aliases -> canonical
  t = t.replace(/\belective\s*maths?\b/, 'elective mathematics');
  t = t.replace(/\be\-?maths?\b/, 'elective mathematics');
  t = t.replace(/\bcore\s*maths?\b/, 'core mathematics');
  t = t.replace(/\bmaths?\b/, 'mathematics');
  t = t.replace(/\bchem\b/, 'chemistry');
  t = t.replace(/\bbio\b/, 'biology');
  t = t.replace(/\bphys(?:ics)?\b/, 'physics');
  t = t.replace(/\beng(?:lish)?\b/, 'english language');
  t = t.replace(/\bintegrated science\b/, 'integrated science');
  t = t.replace(/\bsocial studies\b/, 'social studies');
  t = t.replace(/\bcore mathematics\b/, 'core mathematics');
  t = t.replace(/\belective mathematics\b/, 'elective mathematics');
  t = t.replace(/\bict\b/, 'ict');
  t = t.replace(/\bgeography\b/, 'geography');
  t = t.replace(/\beconomics\b/, 'economics');
  t = t.replace(/\baccounting\b/, 'accounting');
  // remove parentheses content
  t = t.replace(/\s*\(.*?\)\s*/g, ' ').trim();
  return t;
}

/* normalize array of subjects */
function normalizeArray(arr){ return (arr||[]).map(normalizeSubject).filter(x=>x && x.length); }

/* subjectPresent: must match normalized token sets strictly (but tolerant)
   returns boolean
*/
function subjectPresent(subjectGrades, requiredSubjectName){
  if (!requiredSubjectName) return true;
  const req = normalizeSubject(requiredSubjectName || '');
  if (!req) return true;
  const provided = Object.keys(subjectGrades || {}).map(k=>normalizeSubject(k)).filter(Boolean);
  if (provided.includes(req)) return true;
  // token-match tolerant: all tokens in req must appear in a provided subject token list
  const reqTokens = req.split(/\s+/).filter(Boolean);
  for (let p of provided){
    const pTokens = p.split(/\s+/);
    let all = true;
    for (let t of reqTokens){
      if (!pTokens.includes(t)) { all = false; break; }
    }
    if (all) return true;
  }
  return false;
}

/* findProvidedSubjectKey: returns the original subject key from user inputs that best matches 'required'
   or null
*/
function findProvidedSubjectKey(subjectGrades, required){
  const req = normalizeSubject(required||'');
  for (let key of Object.keys(subjectGrades||{})){
    if (normalizeSubject(key) === req) return key;
  }
  for (let key of Object.keys(subjectGrades||{})){
    if (normalizeSubject(key).includes(req) || req.includes(normalizeSubject(key))) return key;
  }
  return null;
}

/* computeAggregate: best 6 graded subjects */
function computeAggregate(subjectGrades){
  const graded = Object.entries(subjectGrades)
    .filter(([s,g]) => g && GRADE_TO_SCORE[g])
    .map(([s,g]) => ({ s: s.trim(), score: GRADE_TO_SCORE[g] }));
  if (graded.length === 0) return { aggregate: Infinity, ranked: [] };
  const scores = graded.map(g => g.score).sort((a,b)=>a-b);
  const best6 = scores.slice(0,6);
  const aggregate = best6.reduce((a,b)=>a+b,0);
  return { aggregate, ranked: graded.sort((a,b)=>a.score-b.score) };
}

/* isCredit: A1-C6 are credits */
function isCredit(grade){
  return grade && GRADE_TO_SCORE[grade] && GRADE_TO_SCORE[grade] <= 6;
}

/* corePasses: per-university cores */
function corePasses(subjectGrades, uniKey){
  const rules = UNIVERSITY_RULES[uniKey] || { cores: ["english language","mathematics","integrated science","social studies"], coreRequiredCount:2 };
  const cores = (rules.cores || []).map(normalizeSubject);
  const requiredCount = rules.coreRequiredCount || 2;
  let passed = 0, passedList=[], failedList=[];
  for (let c of cores){
    // find a provided subject that matches c
    const providedKeys = Object.keys(subjectGrades || {});
    let foundGood = false;
    for (let pk of providedKeys){
      const nk = normalizeSubject(pk);
      if (!nk) continue;
      // treat "mathematics" equivalent to "core mathematics" for checking
      if (nk === c || nk.includes(c) || c.includes(nk)){
        const grade = subjectGrades[pk];
        if (isCredit(grade)){
          foundGood = true; break;
        }
      }
    }
    if (foundGood){ passed++; passedList.push(c); }
    else failedList.push(c);
  }
  return { passed, passedList, failedList, coreOk: (passed >= requiredCount) };
}


/* ============================
   NEW: Dynamic KNUST stream-aware checker
   - Generates elective groups for programmes heuristically based on programme name.
   - This avoids manually listing thousands of programmes; it captures typical KNUST rules:
     * Engineering/Architecture: science/technical groups
     * Agriculture/Agribusiness: science, business, arts, agriculture groups
     * Health (Medicine/Nursing/Pharmacy/Optometry): biology+chemistry(+physics)
     * Business/Accounting/Finance: business group
     * Law/Arts/Ed: arts/business groups
     * Computer/IT/Data: mathematics/elective mathematics (+physics)
   - Returns { satisfied: bool, matchedGroupName: string|null, reasons: { nonCredit: [] } }
   ============================ */
function knustStreamCheck(programDef, subjectGrades, shsTrack){
  const name = (programDef.name||programDef.canonicalType||'').toString().toLowerCase();
  const reasons = { nonCredit: [] };
  // Helpers
  const normProvided = Object.keys(subjectGrades||{}).map(k=>({ original:k, norm: normalizeSubject(k), grade: subjectGrades[k]}));
  function countCredits(pool){
    let cnt=0;
    for (let subj of pool){
      const target = normalizeSubject(subj);
      for (let p of normProvided){
        if (p.norm === target || p.norm.includes(target) || target.includes(p.norm)){
          if (isCredit(p.grade)) cnt++; else reasons.nonCredit.push({subject: subj, providedGrade: p.grade||'missing'});
          break;
        }
      }
    }
    return cnt;
  }
  // Define common pools
  const POOLS = {
    science: ["Physics","Chemistry","Biology","Mathematics","Elective Mathematics"],
    business: ["Economics","Accounting","Business Management","Cost Accounting","Elective Mathematics","Business Mathematics"],
    arts: ["Geography","Government","History","Literature in English","French","Ghanaian Language","Elective Mathematics"],
    agriculture: ["General Agriculture","Biology","Crop Husbandry","Horticulture","Chemistry"],
    technical: ["Technical Drawing","Technical Drawing & Design","Metal Work","Building Construction","Design & Communication Technology","Electronics"],
    health: ["Biology","Chemistry","Physics"]
  };

  // Heuristic group definitions per programme keyword
  const groups = [];

  if (name.includes("agribusiness") || name.includes("agriculture") || name.includes("forestry") || name.includes("horticulture")){
    groups.push({name:"Science/Agric group", pool: POOLS.agriculture.concat(["Chemistry","Physics","Mathematics"]), minCredits:3, requiresIntegrated:false});
    groups.push({name:"Business group", pool: POOLS.business, minCredits:3, requiresIntegrated:true});
    groups.push({name:"General Arts group", pool: POOLS.arts, minCredits:3, requiresIntegrated:true});
  } else if (name.includes("architecture") || name.includes("quantity") || name.includes("building") || name.includes("construction") || name.includes("land economy") || name.includes("planning")){
    groups.push({name:"Technical/Visual group", pool: POOLS.technical.concat(["Graphic Design","Picture Making","Textiles"]), minCredits:2, requiresIntegrated:false});
    groups.push({name:"Science group", pool: ["Physics","Elective Mathematics","Mathematics","Chemistry"], minCredits:2, requiresIntegrated:false});
    groups.push({name:"Arts group", pool: ["Geography","Economics","Elective Mathematics"], minCredits:2, requiresIntegrated:false});
  } else if (name.includes("engineering") || name.includes("mechanical") || name.includes("electrical") || name.includes("chemical") || name.includes("petroleum") || name.includes("civil") || name.includes("mining") || name.includes("geomatic") || name.includes("materials")){
    groups.push({name:"Engineering/Science group", pool:["Elective Mathematics","Mathematics","Physics","Chemistry"], minCredits:2, requiresIntegrated:false});
    groups.push({name:"Technical group", pool: POOLS.technical.concat(["Elective Mathematics"]), minCredits:2, requiresIntegrated:false});
  } else if (name.includes("medicine") || name.includes("mbchb") || name.includes("nursing") || name.includes("pharm") || name.includes("optometry") || name.includes("physiotherapy") || name.includes("midwifery") || name.includes("dietet") || name.includes("medical")){
    groups.push({name:"Health Sciences group", pool: POOLS.health, minCredits:3, requiresIntegrated:false});
  } else if (name.includes("computer") || name.includes("information technology") || name.includes("it") || name.includes("data") || name.includes("software") || name.includes("computer science")){
    groups.push({name:"Maths/IT group", pool:["Elective Mathematics","Mathematics","Physics","ICT"], minCredits:2, requiresIntegrated:false});
  } else if (name.includes("business") || name.includes("accounting") || name.includes("finance") || name.includes("banking") || name.includes("management") || name.includes("marketing") || name.includes("logistics") || name.includes("actuarial")){
    groups.push({name:"Business group", pool: POOLS.business, minCredits:2, requiresIntegrated:false});
    groups.push({name:"Maths/Science group", pool:["Elective Mathematics","Mathematics","Physics"], minCredits:2, requiresIntegrated:false});
    groups.push({name:"Arts group", pool: POOLS.arts, minCredits:2, requiresIntegrated:false});
  } else if (name.includes("law") || name.includes("llb") || name.includes("political") || name.includes("history") || name.includes("english") || name.includes("communication") || name.includes("social")){
    groups.push({name:"Arts/Business group", pool: POOLS.arts.concat(POOLS.business), minCredits:3, requiresIntegrated:false});
  } else if (name.includes("education") || name.includes("ed ") || name.startsWith("bed") || name.includes("teacher")){
    groups.push({name:"Education group", pool: POOLS.arts.concat(["Core Mathematics","Mathematics","Elective Mathematics"]), minCredits:2, requiresIntegrated:false});
  } else {
    // fallback: allow science, business or arts groups; conservative minCredits 2
    groups.push({name:"Science group", pool: POOLS.science, minCredits:2, requiresIntegrated:false});
    groups.push({name:"Business group", pool: POOLS.business, minCredits:2, requiresIntegrated:false});
    groups.push({name:"Arts group", pool: POOLS.arts, minCredits:2, requiresIntegrated:false});
  }

  // Evaluate groups: satisfied if credited subjects count >= minCredits
  for (let g of groups){
    const credits = countCredits(g.pool);
    if (credits >= g.minCredits){
      // if requiresIntegrated, ensure Integrated Science credit
      if (g.requiresIntegrated){
        const isk = normProvided.find(x=> x.norm === normalizeSubject('Integrated Science'));
        if (isk && isCredit(isk.grade)){
          return { satisfied:true, matchedGroupName: g.name, reasons };
        } else {
          reasons.nonCredit.push({subject:'Integrated Science', providedGrade: isk?isk.grade:'missing'});
          continue;
        }
      } else {
        return { satisfied:true, matchedGroupName: g.name, reasons };
      }
    }
  }
  return { satisfied:false, matchedGroupName:null, reasons };
}
/* isEligibleForProgram: per-university strict logic (Option C)
   rules:
     - requiredSubjects must be present and credit (A1-C6)
     - core passes according to UNIVERSITY_RULES
     - aggregate computed (best-6) must be <= maxAggregate when provided and rule requires strictCutoff
     - if maxAggregate null but uni requires 6Subjects, require at least 6 graded subjects to compute aggregate; otherwise treat conservatively
     - SHS track mismatch used ONLY as advisory (doesn't override required subject presence)
*/

function isEligibleForProgram(programDef, subjectGrades, shsTrack, uniKey){
  // Enhanced eligibility evaluator with PROGRAM_SPECIFIC_RULES integration
  const reasons = { missingSubjects: [], nonCreditSubjects: [], trackMismatch:false, coreOk:false, aggregateOk:true, aggregate:Infinity, computed:false, streamGroupMatched: null };
  const rule = UNIVERSITY_RULES[uniKey] || {};

  // Helper: normalize program key
  const progKey = (programDef.canonicalType || programDef.name || '').toString().toLowerCase().replace(/\s+/g,' ').trim();

  // 1) If a program-specific rule exists for this university, evaluate it (strict)
  if (PROGRAM_SPECIFIC_RULES[uniKey] && PROGRAM_SPECIFIC_RULES[uniKey][progKey]){
    const pr = PROGRAM_SPECIFIC_RULES[uniKey][progKey];
    // check core subjects
    for (let coreSubj of (pr.core||[])){
      const providedKey = findProvidedSubjectKey(subjectGrades, coreSubj);
      const grade = providedKey ? subjectGrades[providedKey] : null;
      if (!providedKey){
        reasons.missingSubjects.push(coreSubj);
      } else if (!isCredit(grade)){
        reasons.nonCreditSubjects.push({ subject: coreSubj, providedGrade: grade || 'missing' });
      }
    }
    // if any core missing/non-credit, fail early (but we will still compute aggregate for info)
    const coreRes = corePasses(subjectGrades, uniKey);
    reasons.coreOk = coreRes.coreOk;
    reasons.passedCores = coreRes.passedList;
    reasons.failedCores = coreRes.failedList;

    // evaluate electiveGroups: must satisfy at least one group
    let groupMatched = null;
    const groupReasons = [];
    for (let g of (pr.electiveGroups||[])){
      let creditCount = 0;
      for (let subj of g.pool){
        const pk = findProvidedSubjectKey(subjectGrades, subj);
        if (pk && isCredit(subjectGrades[pk])) creditCount++;
      }
      // special integrated science min check if required
      if (g.requiresIntegratedScienceCredit){
        const isk = findProvidedSubjectKey(subjectGrades, 'Integrated Science');
        if (!(isk && isCredit(subjectGrades[isk]))){
          groupReasons.push({ group: g.name, ok:false, reason: 'Integrated Science requires credit' });
          continue;
        }
      }
      if (creditCount >= (g.minCredits||1)){
        groupMatched = g.name; break;
      } else {
        groupReasons.push({ group: g.name, ok:false, got: creditCount, need: g.minCredits||1 });
      }
    }
    if (groupMatched){
      reasons.streamGroupMatched = groupMatched;
    } else {
      reasons.missingSubjects.push('Elective group requirements not satisfied (' + (groupReasons.map(r=> r.group + ': got ' + (r.got||0) + ' need ' + (r.need||g.minCredits||1)).join('; ')) + ')');
    }

    // aggregate compute
    const aggObj = computeAggregate(subjectGrades);
    reasons.aggregate = aggObj.aggregate;
    reasons.computed = (aggObj.aggregate !== Infinity);

    if (typeof pr.minAggregate === 'number'){
      if (!reasons.computed) reasons.aggregateOk = false;
      else reasons.aggregateOk = (aggObj.aggregate <= pr.minAggregate);
    } else if (typeof programDef.maxAggregate === 'number'){
      if (rule.strictCutoff){
        if (!reasons.computed) reasons.aggregateOk = false;
        else reasons.aggregateOk = (aggObj.aggregate <= programDef.maxAggregate);
      } else {
        if (reasons.computed) reasons.aggregateOk = (aggObj.aggregate <= programDef.maxAggregate);
      }
    } else {
      // default behaviour: require computed aggregate if uni requires 6 subjects
      if (rule.require6Subjects) reasons.aggregateOk = reasons.computed;
      else reasons.aggregateOk = true;
    }

    const eligible = reasons.missingSubjects.length === 0 && reasons.nonCreditSubjects.length === 0 && reasons.coreOk && reasons.aggregateOk && (reasons.streamGroupMatched !== null);
    return { eligible, reasons };
  }

  // 2) Fallback: original generic behavior (no program-specific rule)
  const reqs = programDef.requiredSubjects || [];
  for (let req of reqs){
    if (!subjectPresent(subjectGrades, req)){
      reasons.missingSubjects.push(req);
    } else {
      const providedKey = findProvidedSubjectKey(subjectGrades, req);
      const grade = providedKey ? subjectGrades[providedKey] : null;
      if (!isCredit(grade)){
        reasons.nonCreditSubjects.push({ subject: req, providedGrade: grade || 'missing' });
      }
    }
  }

  // SHS track advisory only
  const tk = (shsTrack||'').toString().trim().toLowerCase().replace(/\s+/g,'');
  const allowed = SHS_TRACK_RULES[tk] || [];
  const canonicalType = (programDef.canonicalType||programDef.name||'').toString().toLowerCase();
  if (allowed.length && !allowed.includes(canonicalType)){
    reasons.trackMismatch = true;
  } else {
    reasons.trackMismatch = false;
  }

  // core check
  const core = corePasses(subjectGrades, uniKey);
  reasons.coreOk = core.coreOk;
  reasons.passedCores = core.passedList;
  reasons.failedCores = core.failedList;

  // aggregate
  const aggObj = computeAggregate(subjectGrades);
  reasons.aggregate = aggObj.aggregate;
  reasons.computed = (aggObj.aggregate !== Infinity);

  if (typeof programDef.maxAggregate === 'number'){
    if (rule.strictCutoff){
      if (!reasons.computed) reasons.aggregateOk = false;
      else reasons.aggregateOk = (aggObj.aggregate <= programDef.maxAggregate);
    } else {
      if (reasons.computed) reasons.aggregateOk = (aggObj.aggregate <= programDef.maxAggregate);
      else reasons.aggregateOk = true;
    }
  } else {
    if (rule.require6Subjects){
      reasons.aggregateOk = reasons.computed;
    } else {
      reasons.aggregateOk = true;
    }
  }

  const eligible = (reasons.missingSubjects.length === 0)
                 && (reasons.nonCreditSubjects.length === 0)
                 && reasons.coreOk
                 && reasons.aggregateOk;

  return { eligible, reasons };
}
/* generateUniversityMatches: run per-program check, produce matches & close list */
function generateUniversityMatches(uniKey, subjectGrades, shsTrack){
  const programmes = (JSON.parse(JSON.stringify(DEFAULT_UNIVERSITY_PROGRAMMES[uniKey] || [])));
  const matches = [], close = [];
  for (let p of programmes){
    const res = isEligibleForProgram(p, subjectGrades, shsTrack, uniKey);
    if (res.eligible) matches.push({ name: p.name, def: p, reasons: res.reasons });
    else close.push({ name: p.name, def: p, reasons: res.reasons });
  }
  matches.sort((a,b)=> (a.reasons.aggregate||999) - (b.reasons.aggregate||999));
  close.sort((a,b)=> (a.reasons.aggregate||999) - (b.reasons.aggregate||999));
  return { matches, close };
}

/* ============================
   UI wiring (subject rows, mapping editor, rendering)
   ============================ */

const subjectListEl = document.getElementById('subjectList');
const addSubBtn = document.getElementById('addSub');
const resetSubsBtn = document.getElementById('resetSubs');
const payThenGenerateBtn = document.getElementById('payThenGenerate');
const resultsEl = document.getElementById('results');
const mappingsTA = document.getElementById('mappings');
const saveMapBtn = document.getElementById('saveMap');
const loadDefBtn = document.getElementById('loadDefaults');
const streamSel = document.getElementById('stream');
const uniSel = document.getElementById('university');
const demoRunBtn = document.getElementById('demoRun');

let paymentDone = false;
let lastPaymentRef = null;

/* SHS PROGRAMS default subjects (REPLACED with cleaned version per request) */
const SHS_PROGRAMS = {
  "GeneralScience": [
    "English Language",
    "Mathematics",
    "Integrated Science",
    "Biology",
    "Chemistry",
    "Physics",
    "Elective Mathematics",
    "ICT",
    "Geography"
  ],
  "GeneralArts": [
    "English Language",
    "Mathematics",
    "Social Studies",
    "Government",
    "History",
    "Economics",
    "Geography",
    "Literature in English",
    "Elective Mathematics",
    "French",
    "G.K.A",
    "CRS",
    "Ghanaian Language",
    "Elective ICT"
  ],
  "Business": [
    "English Language",
    "Mathematics",
    "Financial Accounting",
    "Business Management",
    "Economics",
    "Cost Accounting",
    "Elective ICT",
    "Elective Mathematics"
  ],
  "Agricultural": [
    "English Language",
    "Mathematics",
    "General Agriculture",
    "Animal Husbandry",
    "Chemistry",
    "Biology",
    "Elective Mathematics"
  ],
  "HomeEconomics": [
    "English Language",
    "Mathematics",
    "Food & Nutrition",
    "Management in Living",
    "Biology",
    "Clothing & Textiles",
    "G.K.A",
    "French",
    "Economics",
    "Chemistry",
    "Music"
  ],
  "VisualArts": [
    "English Language",
    "Mathematics",
    "Graphic Design",
    "Picture Making",
    "Ceramics",
    "Sculpture",
    "Textiles",
    "G.K.A",
    "ICT",
    "Economics",
    "Elective Mathematics"
  ],
  "Technical": [
    "English Language",
    "Mathematics",
    "Integrated Science",
    "Applied Electricity",
    "Electronics",
    "Metal Work",
    "Building Construction",
    "Elective Mathematics"
  ]
};

function createSubjectRow(subjectName='', grade=''){
  const row = document.createElement('div'); row.className = 'subject-row';
  const input = document.createElement('input'); input.type='text'; input.placeholder='Subject (e.g. Mathematics)'; input.value=subjectName;
  const sel = document.createElement('select');
  ['', 'A1','B2','B3','C4','C5','C6','D7','E8','F9'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(v===grade) o.selected=true; sel.appendChild(o); });
  const del = document.createElement('button'); del.type='button'; del.className='ghost'; del.textContent='Remove'; del.style.flex='0';
  del.addEventListener('click', ()=>row.remove());
  input.addEventListener('focus', ()=>{ 
    // show suggestions based on currently selected stream (safe fallback)
    const sKey = streamSel.value || 'GeneralScience';
    const suggestions = (SHS_PROGRAMS[sKey]||SHS_PROGRAMS['GeneralScience']).slice(0,15).join(', ');
    input.title = 'Suggestions: ' + suggestions; 
  });
  row.appendChild(input); row.appendChild(sel); row.appendChild(del);
  return row;
}

function populateDefaultSubjects(streamKey){
  subjectListEl.innerHTML = '';
  const streamSubjects = SHS_PROGRAMS[streamKey] || [];
  // Always include core suggestions first
  ['English Language','Mathematics','Integrated Science','Social Studies'].forEach(s => subjectListEl.appendChild(createSubjectRow(s,'')));
  // add the rest from the stream (avoid duplicates)
  streamSubjects.filter(s=>!['English Language','Mathematics','Integrated Science','Social Studies'].includes(s)).forEach(s=>subjectListEl.appendChild(createSubjectRow(s,'')));
}
addSubBtn.addEventListener('click', ()=>subjectListEl.appendChild(createSubjectRow()));
resetSubsBtn.addEventListener('click', ()=>populateDefaultSubjects(streamSel.value));
streamSel.addEventListener('change', ()=>populateDefaultSubjects(streamSel.value));
populateDefaultSubjects(streamSel.value);

/* gatherSubjects: returns { "English Language": "B3", ... } */
function gatherSubjects(){
  const rows = Array.from(subjectListEl.children);
  const subjects = {};
  rows.forEach(r => {
    const name = r.querySelector('input').value.trim();
    const grade = r.querySelector('select').value;
    if (name) subjects[name] = grade || null;
  });
  return subjects;
}

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

function renderMatches(matches){
  resultsEl.innerHTML = '';
  if (matches.length === 0){ resultsEl.innerHTML = '<div class="hint">No exact matches found. Showing close matches below:</div>'; return; }
  matches.forEach(m=>{
    const el = document.createElement('div'); el.className='programme';
    let html = '<strong>' + escapeHtml(m.name) + '</strong>';
    html += '<span class="qualified-label"> QUALIFIED</span>';
    html += '<div class="program-meta"><div class="tag">Required: ' + (m.def.requiredSubjects && m.def.requiredSubjects.length ? escapeHtml(m.def.requiredSubjects.join(', ')) : 'None specified') + '</div>';
    html += '<div class="tag">Calculated aggregate (best 6): ' + (isFinite(m.reasons.aggregate) ? m.reasons.aggregate : 'N/A') + '</div>';
    if (m.def.maxAggregate) html += '<div class="tag">Program max aggregate: ' + m.def.maxAggregate + '</div>';
    html += '</div>';
    // advisory: track mismatch shown but not blocking
    if (m.reasons.trackMismatch) html += '<div class="reason">Note: Your SHS track does not typically feed this programme (advisory only).</div>';
    el.innerHTML = html; resultsEl.appendChild(el);
  });
}

function renderClose(close){
  close.forEach(c=>{
    const el = document.createElement('div'); el.className='programme';
    let html = '<strong>' + escapeHtml(c.name) + '</strong>';
    html += '<div class="program-meta"><div class="tag">Required: ' + (c.def.requiredSubjects && c.def.requiredSubjects.length ? escapeHtml(c.def.requiredSubjects.join(', ')) : 'None specified') + '</div>';
    html += '<div class="tag">Calculated aggregate (best 6): ' + (isFinite(c.reasons.aggregate) ? c.reasons.aggregate : 'N/A') + '</div>';
    if (c.def.maxAggregate) html += '<div class="tag">Program max aggregate: ' + c.def.maxAggregate + '</div>';
    html += '</div>';
    html += '<div class="reason">' + (c.reasons.trackMismatch ? '<span class="bad">SHS track advisory only</span>' : '') + '</div>';
    html += '<div class="reason">Missing subjects: ' + (c.reasons.missingSubjects.length ? escapeHtml(c.reasons.missingSubjects.join(', ')) : 'None') + '</div>';
    if (c.reasons.nonCreditSubjects && c.reasons.nonCreditSubjects.length){
      html += '<div class="reason">Subjects without credit: ' + c.reasons.nonCreditSubjects.map(x=>escapeHtml(x.subject + ' (' + x.providedGrade + ')')).join(', ') + '</div>';
    }
    html += '<div class="reason">Core (required) pass: ' + (c.reasons.coreOk ? '<span class="good">Yes</span>' : '<span class="bad">No</span>') + '</div>';
    el.innerHTML = html; resultsEl.appendChild(el);
  });
}

/* Payment (kept same). For demo/testing we allow demoRunBtn to bypass payment. */
const PAYSTACK_PUBLIC_KEY = 'pk_live_f532466c75c8b98273bf10ec2c579ce049282a5f';
const PAYMENT_AMOUNT_SMALLEST_UNIT = 1800;
function startPaystackPayment(email='customer@example.com'){
  return new Promise((resolve,reject)=>{
    if (!window.PaystackPop) return reject(new Error('Paystack library not loaded'));
    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: email,
      amount: PAYMENT_AMOUNT_SMALLEST_UNIT,
      currency: 'GHS',
      channels: ['card','mobile_money'],
      onClose: function(){ reject(new Error('Payment window closed')) },
      callback: function(response){ resolve(response) }
    });
    handler.openIframe();
  });
}

/* Main button handler */
payThenGenerateBtn.addEventListener('click', async ()=>{
  resultsEl.innerHTML = '';
  const subjectGrades = gatherSubjects();
  const provided = Object.keys(subjectGrades).filter(k=>subjectGrades[k] && subjectGrades[k] !== '');
  if (provided.length < 2){
    resultsEl.innerHTML = '<div class="hint" style="color:var(--muted)">Please enter at least 2 graded subjects (English/Maths etc.).</div>';
    return;
  }

  if (!paymentDone){
    try {
      payThenGenerateBtn.disabled = true;
      payThenGenerateBtn.textContent = 'Processing payment...';
      const email = prompt('Enter an email for the receipt (used by Paystack):', 'applicant@example.com') || 'applicant@example.com';
      const payResp = await startPaystackPayment(email);
      lastPaymentRef = payResp.reference || null;
      paymentDone = true;
      payThenGenerateBtn.textContent = 'Paid â€” generating results';
      setTimeout(()=>payThenGenerateBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes', 1000);
    } catch (err) {
      paymentDone = false;
      payThenGenerateBtn.disabled = false;
      payThenGenerateBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
      resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Payment failed or cancelled â€” cannot show results. Try again.</div>';
      return;
    }
  }

  const uniKey = uniSel.value;
  const shsTrack = streamSel.value;
  const programmes = DEFAULT_UNIVERSITY_PROGRAMMES[uniKey] || [];
  if (!programmes || programmes.length === 0){
    resultsEl.innerHTML = '<div class="hint">No programme mappings found for selected university. Load defaults or configure mappings below.</div>';
    return;
  }
  const out = generateUniversityMatches(uniKey, subjectGrades, shsTrack);
  resultsEl.innerHTML = '';
  if (out.matches.length === 0){
    resultsEl.innerHTML = '<div class="hint">No exact matches found. Showing close matches (missing subjects, non-credit subjects, or aggregate too high):</div>';
    renderClose(out.close.slice(0, 64));
    return;
  }
  renderMatches(out.matches);
  if (out.close.length){
    const sep = document.createElement('div'); sep.className='hint'; sep.style.marginTop='12px'; sep.textContent='Other close matches (review reasons):';
    resultsEl.appendChild(sep);
    renderClose(out.close.slice(0, 24));
  }
});

/* demo run bypass payment */
demoRunBtn.addEventListener('click', ()=>{
  paymentDone = true;
  lastPaymentRef = 'DEMO';
  payThenGenerateBtn.disabled = false;
  resultsEl.innerHTML = '<div class="hint">Demo mode enabled â€” results will be generated without payment.</div>';
});

/* Clear */
document.getElementById('clearRes').addEventListener('click', ()=>{ resultsEl.innerHTML=''; paymentDone=false; lastPaymentRef=null; });

/* Admin mappings persistence (localStorage) */
function getMappings(){ try{ const raw = localStorage.getItem('uni_mappings_v3'); if (!raw) return DEFAULT_UNIVERSITY_PROGRAMMES; return JSON.parse(raw); }catch(e){ return DEFAULT_UNIVERSITY_PROGRAMMES; } }
function saveMappings(obj){ localStorage.setItem('uni_mappings_v3', JSON.stringify(obj, null, 2)); }
function loadMappingsToTA(){ mappingsTA.value = JSON.stringify(getMappings(), null, 2); }
loadMappingsToTA();
saveMapBtn.addEventListener('click', ()=>{ try{ const parsed = JSON.parse(mappingsTA.value); saveMappings(parsed); alert('Mappings saved locally. Verify program rules with official university pages.'); }catch(e){ alert('Invalid JSON â€” please fix before saving.'); } });
loadDefBtn.addEventListener('click', ()=>{ mappingsTA.value = JSON.stringify(DEFAULT_UNIVERSITY_PROGRAMMES, null, 2); });

/* initialize UI mapping text area with defaults */
mappingsTA.value = JSON.stringify(DEFAULT_UNIVERSITY_PROGRAMMES, null, 2);

  </script>

<!-- BEGIN: Paystack production integration (injected) -->

<script>
(function(){
  // Placeholder - replace in index.html before deploy
  const PAYSTACK_PUBLIC_KEY = 'pk_live_f532466c75c8b98273bf10ec2c579ce049282a5f';
  const PAYMENT_AMOUNT_SMALLEST_UNIT = 1800; // GHâ‚µ18

  function startPaystackPayment(email){
    return new Promise((resolve, reject) => {
      if (!window.PaystackPop) return reject(new Error('Paystack library not loaded'));
      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: PAYMENT_AMOUNT_SMALLEST_UNIT,
        currency: 'GHS',
        channels: ['card','mobile_money','bank_transfer'],
        callback: function(response){
          resolve(response);
        },
        onClose: function(){
          reject(new Error('Payment window closed'));
        }
      });
      handler.openIframe();
    });
  }

  async function verifyPaymentOnServer(reference){
    try {
      const response = await fetch(`/.netlify/functions/verify?reference=${reference}`);
      const result = await response.json();
    }
        body: JSON.stringify({ reference })
      });
      return await r.json();
    } catch (e) {
      return { error: 'verification-request-failed', details: e.message || String(e) };
    }
  }

  // Replace original button listeners by cloning the node (removes previously attached listeners)
  function replaceButtonHandler() {
    const oldBtn = document.getElementById('payThenGenerate');
    if (!oldBtn) return;
    // remove demo button if present
    const demo = document.getElementById('demoRun');
    if (demo && demo.parentNode) demo.parentNode.removeChild(demo);

    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);

    newBtn.addEventListener('click', async function handler(e){
      e.preventDefault();
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = '';

      // gatherSubjects is defined in your original script
      try {
        const subjectGrades = (typeof gatherSubjects === 'function') ? gatherSubjects() : null;
        if (!subjectGrades) {
          resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Internal error: gatherSubjects() not found.</div>';
          return;
        }
        const provided = Object.keys(subjectGrades).filter(k=>subjectGrades[k] && subjectGrades[k] !== '');
        if (provided.length < 2){
          resultsEl.innerHTML = '<div class="hint" style="color:var(--muted)">Please enter at least 2 graded subjects (English/Maths etc.).</div>';
          return;
        }

        // If payment already verified earlier in this session, just generate
        if (window.__unifinder_payment_done === true) {
          const out = generateUniversityMatches(document.getElementById('university').value, subjectGrades, document.getElementById('stream').value);
          if (out.matches && out.matches.length) {
            renderMatches(out.matches);
            if (out.close && out.close.length){
              const sep = document.createElement('div'); sep.className='hint'; sep.style.marginTop='12px'; sep.textContent='Other close matches (review reasons):';
              resultsEl.appendChild(sep);
              renderClose(out.close.slice(0,24));
            }
            return;
          } else {
            resultsEl.innerHTML = '<div class="hint">No exact matches found. Showing close matches:</div>';
            renderClose(out.close.slice(0,64));
            return;
          }
        }

        // Ask for email for receipt
        const email = prompt('Enter an email for the receipt (used by Paystack):', 'applicant@example.com') || 'applicant@example.com';
        // start Paystack
        newBtn.disabled = true;
        newBtn.textContent = 'Processing payment...';
        let payResp;
        try {
          payResp = await startPaystackPayment(email);
        } catch (payErr) {
          console.error('Payment popup error', payErr);
          resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Payment cancelled or failed. Try again.</div>';
          newBtn.disabled = false;
          newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
          return;
        }

        const reference = payResp && payResp.reference ? payResp.reference : null;
        if (!reference) {
          resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Payment returned no reference. Contact support.</div>';
          newBtn.disabled = false;
          newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
          return;
        }

        // verify on server
        const verification = await verifyPaymentOnServer(reference);
        if (!(verification && verification.status && verification.data && verification.data.status === 'success')) {
          console.error('Verification failed', verification);
          resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Payment verification failed. If you were charged, contact support with reference '+ reference +'</div>';
          newBtn.disabled = false;
          newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
          return;
        }

        // check amount
        const paidAmount = Number(verification.data.amount || 0);
        if (paidAmount < PAYMENT_AMOUNT_SMALLEST_UNIT) {
          resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Insufficient payment amount recorded by Paystack.</div>';
          newBtn.disabled = false;
          newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
          return;
        }

        // mark as paid and generate
        window.__unifinder_payment_done = true;
        window.__unifinder_last_ref = reference;
        newBtn.textContent = 'Paid â€” generating results';
        setTimeout(()=> newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes', 900);

        const out = generateUniversityMatches(document.getElementById('university').value, subjectGrades, document.getElementById('stream').value);
        resultsEl.innerHTML = '';
        if (out.matches.length === 0){
          resultsEl.innerHTML = '<div class="hint">No exact matches found. Showing close matches:</div>';
          renderClose(out.close.slice(0, 64));
          newBtn.disabled = false;
          return;
        }
        renderMatches(out.matches);
        if (out.close.length){
          const sep = document.createElement('div'); sep.className='hint'; sep.style.marginTop='12px'; sep.textContent='Other close matches (review reasons):';
          resultsEl.appendChild(sep);
          renderClose(out.close.slice(0, 24));
        }
        newBtn.disabled = false;
      } catch(e){
        console.error('Unhandled error in payment flow', e);
        resultsEl.innerHTML = '<div class="hint" style="color:var(--danger)">Internal error: ' + (e && e.message ? e.message : String(e)) + '</div>';
        newBtn.disabled = false;
        newBtn.textContent = 'Pay GHâ‚µ18 & Get Programmes';
      }
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', replaceButtonHandler);
  else replaceButtonHandler();

})();

// === Production payment override (injected by assistant) ===
// Uses the LIVE public key and verifies payment server-side via /.netlify/functions/verify
async function startPaystackPayment(email='customer@example.com'){
  return new Promise((resolve, reject) => {
    if (!window.PaystackPop) return reject(new Error('Paystack library not loaded'));
    try {
      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email: email,
        amount: 1800,
        currency: 'GHS',
        channels: ['card','mobile_money'],
        onClose: function(){ reject(new Error('Payment window closed')); },
        callback: async function(response){
          const reference = response && response.reference;
          if (!reference) return reject(new Error('No payment reference returned by Paystack'));
          try {
            const fetchResp = await fetch('/.netlify/functions/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reference })
            });
            if (!fetchResp.ok) {
              const txt = await fetchResp.text().catch(()=>null);
              return reject(new Error('Verification endpoint error: ' + (txt || fetchResp.status)));
            }
            const data = await fetchResp.json();
            const status = data && data.data && (data.data.status || data.data.payment_status || data.data.authorization && data.data.authorization.status);
            if (status === 'success' || status === 'paid') {
              resolve({ reference, verification: data });
            } else {
              reject(new Error('Payment not verified: ' + JSON.stringify(data)));
            }
          } catch (err) { reject(new Error('Verification failed: ' + (err.message || err))); }
        }
      });
      handler.openIframe();
    } catch (err) { reject(err); }
  });
}

</script>
<!-- END: Paystack production integration (injected) -->
</body>
</html>